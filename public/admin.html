<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Admin Chat</title>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body style="font-family: Arial; padding: 20px;">
  <h2>ADMIN CHAT PANEL</h2>

  <button onclick="loadClients()">Tải danh sách khách</button>
  <ul id="clientList"></ul>

  <h3 id="activeClient">Chưa chọn khách nào</h3>

  <div id="history" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: auto;"></div>

  <input id="adminMsg" placeholder="Nhập tin nhắn..." style="width:70%;"/>
  <button onclick="sendMsg()">Gửi</button>

  <script>
    const adminSocket = io("/admin");
    let currentClient = null;

    function loadClients() {
      adminSocket.emit("list_clients");
    }

    adminSocket.on("clients_list", (clients) => {
      const ul = document.getElementById("clientList");
      ul.innerHTML = "";
      clients.forEach(id => {
        const li = document.createElement("li");
        li.textContent = id;
        li.style.cursor = "pointer";
        li.onclick = () => selectClient(id);
        ul.appendChild(li);
      });
    });

    function selectClient(id) {
      currentClient = id;
      document.getElementById("activeClient").textContent = "Đang chat với: " + id;
      adminSocket.emit("get_history", id);
    }

    adminSocket.on("history", ({ clientId, history }) => {
      if (clientId !== currentClient) return;
      const div = document.getElementById("history");
      div.innerHTML = "";
      history.forEach(m => {
        const p = document.createElement("p");
        p.textContent = (m.from === 'client' ? 'Khách: ' : 'Admin: ') + m.text;
        div.appendChild(p);
      });
      div.scrollTop = div.scrollHeight;
    });

    function sendMsg() {
      const text = document.getElementById("adminMsg").value;
      if (!currentClient || !text.trim()) return alert("Chọn khách & nhập tin nhắn!");
      adminSocket.emit("admin_message", { targetClientId: currentClient, text: text.trim() });
      document.getElementById("adminMsg").value = "";
      // Hiển thị trực tiếp trong lịch sử
      const div = document.getElementById("history");
      const p = document.createElement("p");
      p.textContent = 'Admin: ' + text.trim();
      p.style.color = 'blue';
      div.appendChild(p);
      div.scrollTop = div.scrollHeight;
    }

    adminSocket.on("new_message", ({ clientId, text }) => {
      if (clientId === currentClient) {
        const div = document.getElementById("history");
        const p = document.createElement("p");
        p.textContent = 'Khách: ' + text;
        div.appendChild(p);
        div.scrollTop = div.scrollHeight;
      } else {
        // Nếu là khách mới, có thể thông báo
        alert('Khách mới: ' + clientId);
        loadClients();
      }
    });
  </script>
</body>
</html>
